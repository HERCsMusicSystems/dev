
[import "test"]
[import "midi"]

[[mdt *name *data : *commands] [ACCUMULATOR accu] [TestEq *name *data *x [res : *commands] [accu : *y] [REVERSE *y *x]] [accu]]

[[callback : *command] [accu *command]]

[TestFails "create empty source" [createSource]]
[createLine line1]
[createLine line2]
[createLine line3]
[createLine line4 callback]
[TestWorks "line1 => connectThru => line2" [line1 connectThru line2]]
[TestWorks "line2 => line3" [line2 line3]]
[TestWorks "connnect thru line3 => line4" [connectThru line3 line4]]

[TestWorks "line4 is of MidiLineType" [machine_type line4 MidiLineType]]
[TestWorks "line4 is also of line3 type" [machine_type line4 line3]]
[TestWorks "line4 is also of machine_type" [machine_type line4 machine_type]]
[TestWorks "line4 is also of machine_type" [machine_type line4]]
[TestFails "sum is not of MidiLineType" [machine_type sum MidiLineType]]
[TestWorks ".... but sum is of machine_type" [machine_type sum machine_type]]
[TestFails "MidiLineType is not of MidiLineType" [machine_type MidiLineType MidiLineType]]
[TestWorks "However, MidiLineType is of machine_type" [machine_type MidiLineType machine_type]]
[TestWorks "And again, MidiLineType is of machine_type" [machine_type MidiLineType]]
[TestFails "line4 => MidiLineType" [line4 MidiLineType]]
[TestFails "line4 => connectThru MidiLineType" [line4 connectThru MidiLineType]]
[TestFails "connectThru line4 MidiLineType" [connectThru line4 MidiLineType]]
[TestFails "connectThru MidiLineType line4" [connectThru MidiLineType line4]]

[mdt "defaultDestination" [[keyon 1 61 101]] [defaultDestination] 
	[SELECT
		[[keyon 0 60 100]]
		[[keyon line1 1 61 101]]
	]
]
[mdt "defaultDestination line1" [[keyon 0 48 102]] [defaultDestination line1]
	[SELECT
		[[keyon 0 48 102]]
		[[keyon line1 1 49 103]]
	]
]

[mdt "midi_message"
	[[SYSEX 1 2 3] [polyaftertouch 5 2 3]]
	[midi_message 240 1 2 3 247] [midi_message 165 2 3]
]
[mdt "sysex" [[sysex 1 2 3]] [sysex 1 2 3]]
[mdt "SYSEX" [[SYSEX 1 2 3]] [SYSEX 1 2 3]]
[mdt "sysexch" [[sysex 1 2 3 45]] [sysexch 1 2 3]]
[mdt "SYSEXCH" [[SYSEX 1 2 3 122]] [SYSEXCH 1 2 3]]

[mdt "sysex line1" [[sysex 1 2 3]] [sysex line1 1 2 3]]
[mdt "SYSEX line2" [[SYSEX 1 2 3]] [SYSEX line2 1 2 3]]
[mdt "sysexch line3" [[sysex 1 2 3 45]] [sysexch line3 1 2 3]]
[mdt "SYSEXCH line4" [[SYSEX 1 2 3 122]] [SYSEXCH line4 1 2 3]]

[line4 midi_manufacturers_id]
[mdt "sysex" [[SYSEX 125 72 82 67 115 18 17 115 111 110 100 97]] [sysex 18 17 "sonda"]]

[TestEq "chex       56 32 : *" 40 *x [chex 56 32 : *x]]
[TestEq "chex line2 73 64 *" 41 *x [chex line2 73 32 *x]]
[TestEq "chex line3 73 : *" 9 *x [chex line3 73 : *x]]
[TestEq "chex       75 *" 11 *x [chex 75 *x]]
[mdt "sysex generated by midi_message" [[SYSEX 1 1026 3] [sysex 1025 2 3]] [midi_message 240 1 2 3 247] [midi_message 240 0 0 0 72 82 67 115 1 2 3 247]]

[line4 midi_manufacturers_id 0x7d]
[mdt "sysex chex" [[sysex 1302 17 115 111 110 100 97]] [sysex 0x516 0x11 "sonda"]]
[TestEq "chex *" 127 *x [chex *x]]
[defaultDestination line4]
[TestEq "chex *" 5 *x [chex *x]]
[defaultDestination line1]
[TestEq "chex line4 *" 5 *x [chex line4 *x]]
[mdt "SYSEX chex" [[SYSEX 126 1656 115 111 110 100 97]] [SYSEX 0x7e 0x678 "sonda"]]
[TestEq "chex : *" 127 *x [chex : *x]]
[TestEq "chex line4 : *" 6 *x [chex line4 : *x]]
[TestEq "chexer 0x567" [0x5 0x60 0x7] *x [chexer 0x567 : *x]]
[TestEq "chexer * 0x9 0x80 0x7" 0x987 *x [chexer *x 0x9 0x80 0x7]]

[line4 midi_manufacturers_id 0x43]
[mdt "YAMAHA sysex" [[SYSEX 0x43 1 2 3]] [midi_message 0xf3 0 240 0x43 1 2 3 247]]
[mdt "YAMAHA sysex with channel extension" [[SYSEX 0x43 2049 2 3]] [midi_message 0xf3 8 240 0x43 1 2 3 247]]
[mdt "YAMAHA-based HERCs sysex" [[sysex 1 2 3]] [midi_message 0xf3 0 240 0x43 "HRCs" 1 2 3 247]]
[mdt "YAMAHA-based HERCs sysex with channel extension" [[sysex 4097 2 3]] [midi_message 0xf3 16 240 0x43 "HRCs" 1 2 3 247]]
[mdt "YAMAHA-based HERCs sysex with channel extension above 16" [[sysex 0x567 2 3]] [midi_message 0xf3 0x5 240 0x43 "HRCs" 0x67 2 3 247]]

[mdt "keyon 4 60 100, keyon 75 61 101" [[keyon 4 60 100] [keyon 75 61 101]] [keyon 4 60 100] [keyon 75 61 101]]
[mdt "keyon 5 76 56, keyon 5 77 88, keyon 21 44 55" [[keyon 5 76 56] [keyon 5 77 88] [keyon 21 44 55]] [midi_message 0xf3 0 0x95 76 56 77 88 0xf3 1 0x95 44 55]]
[mdt "keyoff 3 62, keyoff 77 63 97, keyoff 103" [[keyoff 3 62] [keyoff 77 63 97] [control 103 123 0]] [keyoff 3 62] [keyoff 77 63 97] [keyoff 103]]
[mdt "keyoff 7 52, keyoff 7 63 97, keyoff 103" [[keyoff 7 52] [keyoff 7 63 97] [control 103 123 0]] [midi_message 0xf3 0 0x87 52 0 63 97 0xf3 6 0xb7 123 0]]
[mdt "polyaftertouch...." [[polyaftertouch 9 45 56] [polyaftertouch 89 34 23]] [polyaftertouch 9 45 56] [polyaftertouch 89 34 23]]
[mdt "polyaftertouch...." [[polyaftertouch 8 23 34] [polyaftertouch 8 24 25] [polyaftertouch 88 11 22]] [midi_message 0xf3 0 0xa8 23 34 24 25 0xf3 5 0xa8 11 22]]
[mdt "control...." [[control 1 45 56] [control 1 23 34] [control 17 56 67]] [control 1 45 56] [control 1 23 34] [control 17 56 67]]
[mdt "control negative" [[control 17 18 100]] [control 17 18 -28]]
[mdt "control...." [[control 2 45 56] [control 2 23 34] [control 18 56 67]] [midi_message 0xf3 0 0xb2 45 56 23 34 0xf3 1 0xb2 56 67]]
[mdt "programchange...." [[programchange 6 11] [programchange 6 22] [programchange 166 33]] [programchange 6 11] [programchange 6 22] [programchange 166 33]]
[mdt "programchange...." [[programchange 6 11] [programchange 6 22] [programchange 166 33]] [midi_message 0xf3 0 0xc6 11 22 0xf3 10 0xc6 33]]
[mdt "aftertouch...." [[aftertouch 5 88] [aftertouch 5 99] [aftertouch 165 110]] [aftertouch 5 88] [aftertouch 5 99] [aftertouch 165 110]]
[mdt "aftertouch...." [[aftertouch 5 88] [aftertouch 5 99] [aftertouch 165 110]] [midi_message 0xf3 0 0xd5 88 99 0xf3 10 0xd5 110]]
[mdt "pitch...." [[pitch 6 0 100] [pitch 6 101 12] [pitch 86 0 4]] [pitch 6 100] [pitch 6 101 12] [pitch 86 4]]
[mdt "pitch...." [[pitch 6 0 100] [pitch 6 101 12] [pitch 86 0 4]] [midi_message 0xf3 0 0xe6 0 100 101 12 0xf3 5 0xe6 0 4]]
[mdt "0xfx...." [[timingclock] [START] [STOP] [CONTINUE] [activesensing]] [timingclock] [START] [STOP] [CONTINUE] [activesensing]]
[mdt "0xfx...." [[timingclock] [START] [STOP] [CONTINUE] [activesensing]] [midi_message 0xf8 0xfa 0xfc 0xfb 0xfe]]
[mdt "activesensing (line)" [[activesensing]] [activesensing line3]]
[TestFails "activesensing command" [activesensing command]]

[line1 midi_manufacturers_id 0x43]

[mdt "attack...." [[control 173 73 45]] [attack 173 45]]
[mdt "release...." [[control 233 72 87]] [release 233 87]]
[mdt "cutoff...." [[control 5 74 66]] [cutoff 5 66]]
[mdt "resonance...." [[control 23 71 77]] [resonance 23 77]]
[mdt "bank(lsb)...." [[control 1 32 6] [control 1 0 24] [control 2 0 8] [control 2 32 7]] [bank 1 24 6] [bank 2 8] [banklsb 2 7]]
[mdt "named bank...." [[sysex 589 65 115 111 110 100 97] [sysex 4161 66 87 109 97 114 105 110 101 114]] [bank 45 "sonda"] [bank 257 "mariner" 87]]
[mdt "portatime...." [[control 129 5 68]] [portatime 129 68]]
[mdt "volume...." [[control 567 7 101]] [volume 567 101]]
[mdt "volume negative" [[control 567 7 99]] [volume 567 -29]]
[mdt "reverb...." [[control 3 91 34]] [reverb line3 3 34]]
[mdt "chorus...." [[control 4 93 45]] [chorus line3 4 45]]
[mdt "foot...." [[control 5 4 12]] [foot line3 5 12]]
[mdt "breath...." [[control 6 2 23]] [breath line3 6 23]]
[mdt "pan...." [[control 7 10 34]] [pan line3 7 34]]
[mdt "modulation...." [[control 9 1 45]] [modulation line3 9 45]]
[mdt "mono/poly...." [[control 10 126 0] [control 11 127 0]] [mono 10] [poly 11]]
[mdt "porta on/off...." [[control 12 65 127] [control 13 65 0]] [portaon 12] [portaoff 13]]
[mdt "hold on/off...." [[control 14 64 127] [control 15 64 0]] [holdon 14] [holdoff 15]]

[mdt "PITCH...." [[pitch 4 38 5]] [PITCH 4 678]]
[mdt "PITCH...." [[pitch 44 38 5]] [PITCH line3 44 678]]
[mdt "CONTROL...." [[control 46 39 38] [control 46 7 5]] [CONTROL 46 7 678]]
[mdt "CONTROL NEGATIVE" [[control 46 39 0x5A] [control 46 7 0x7A]] [CONTROL 46 7 -678]]
[mdt "CONTROL...." [[control 46 99 38] [control 46 67 5]] [CONTROL line3 46 67 678]]
[mdt "ATTACK...." [[control 56 105 4] [control 56 73 32]] [ATTACK 56 4100]]
[mdt "ATTACK...." [[control 56 105 4] [control 56 73 32]] [ATTACK line3 56 4100]]
[mdt "RELEASE...." [[control 67 104 2] [control 67 72 16]] [RELEASE 67 2050]]
[mdt "RELEASE NEGATIVE" [[control 67 104 0x7e] [control 67 72 0x6f]] [RELEASE 67 -2050]]
[mdt "RELEASE...." [[control 67 104 2] [control 67 72 16]] [RELEASE line3 67 2050]]
[mdt "CUTOFF...." [[control 12 106 4] [control 12 74 32]] [CUTOFF 12 4100]]
[mdt "CUTOFF...." [[control 17 106 4] [control 17 74 32]] [CUTOFF line3 17 4100]]
[mdt "CUTOFF...." [[control 17 106 4] [control 17 74 32]] [CUTOFF 17 4100]]
[mdt "RESONANCE...." [[control 0 103 2] [control 0 71 16]] [RESONANCE 0 2050]]
[mdt "RESONANCE...." [[control 0 103 2] [control 0 71 16]] [RESONANCE line3 0 2050]]
[mdt "RESONANCE...." [[control 21 103 2] [control 21 71 16]] [RESONANCE line3 21 2050]]
[mdt "PORTATIME...." [[control 22 37 4] [control 22 5 32]] [PORTATIME 22 4100]]
[mdt "VOLUME...." [[control 1 39 2] [control 1 7 16]] [VOLUME 1 2050]]
[mdt "REVERB...." [[control 22 123 4] [control 22 91 32]] [REVERB 22 4100]]
[mdt "CHORUS...." [[control 1 125 2] [control 1 93 16]] [CHORUS 1 2050]]
[mdt "FOOT...." [[control 22 36 4] [control 22 4 32]] [FOOT 22 4100]]
[mdt "BREATH...." [[control 1 34 2] [control 1 2 16]] [BREATH 1 2050]]
[mdt "PAN...." [[control 22 42 4] [control 22 10 32]] [PAN 22 4100]]
[mdt "MODULATION...." [[control 1 33 2] [control 1 1 16]] [MODULATION 1 2050]]

[mdt "rpn...." [[control 10 101 127] [control 10 100 127]] [rpn 10]]
[mdt "rpn...." [[control 11 96 12]] [rpn 11 12]]
[mdt "rpn...." [[control 11 97 12]] [rpn 11 -12]]
[mdt "rpn...." [[control 13 101 14] [control 13 100 15]] [rpn 13 14 15]]
[mdt "rpn...." [[control 16 101 17] [control 16 100 18] [control 16 96 19]] [rpn 16 17 18 19]]
[mdt "rpn...." [[control 20 101 21] [control 20 100 22] [control 20 97 6]] [rpn 20 21 22 -6]]
[TestFails "rpn too long" [rpn 20 21 22 23 24]]
[mdt "rpn line...." [[control 10 101 127] [control 10 100 127]] [rpn line3 10]]
[mdt "rpn line...." [[control 11 96 12]] [rpn line3 11 12]]
[mdt "rpn line...." [[control 11 97 12]] [rpn line3 11 -12]]
[mdt "rpn line...." [[control 13 101 14] [control 13 100 15]] [rpn line3 13 14 15]]
[mdt "rpn line...." [[control 16 101 17] [control 16 100 18] [control 16 96 19]] [rpn line3 16 17 18 19]]
[mdt "rpn line...." [[control 20 101 21] [control 20 100 22] [control 20 97 6]] [rpn line3 20 21 22 -6]]
[TestFails "rpn line too long" [rpn line3 20 21 22 23 24]]

[mdt "nrpn...." [[control 10 99 127] [control 10 98 127]] [nrpn 10]]
[mdt "nrpn...." [[control 11 6 12]] [nrpn 11 12]]
[mdt "nrpn...." [[control 11 6 116]] [nrpn 11 -12]]
[mdt "nrpn...." [[control 13 99 14] [control 13 98 15]] [nrpn 13 14 15]]
[mdt "nrpn...." [[control 16 99 17] [control 16 98 18] [control 16 6 19]] [nrpn 16 17 18 19]]
[mdt "nrpn...." [[control 20 99 21] [control 20 98 22] [control 20 6 122]] [nrpn 20 21 22 -6]]
[mdt "nrpn...." [[control 0 99 31] [control 0 98 32] [control 0 38 34] [control 0 6 33]] [nrpn 0 31 32 33 34]]
[TestFails "nrpn too long" [nrpn 2 21 22 23 24 25]]
[mdt "nrpn line...." [[control 10 99 127] [control 10 98 127]] [nrpn line3 10]]
[mdt "nrpn line...." [[control 11 6 12]] [nrpn line3 11 12]]
[mdt "nrpn line...." [[control 11 6 116]] [nrpn line3 11 -12]]
[mdt "nrpn line...." [[control 13 99 14] [control 13 98 15]] [nrpn line3 13 14 15]]
[mdt "nrpn line...." [[control 16 99 17] [control 16 98 18] [control 16 6 19]] [nrpn line3 16 17 18 19]]
[mdt "nrpn line...." [[control 20 99 21] [control 20 98 22] [control 20 6 122]] [nrpn line3 20 21 22 -6]]
[mdt "nrpn line...." [[control 0 99 31] [control 0 98 32] [control 0 38 34] [control 0 6 33]] [nrpn line3 0 31 32 33 34]]
[TestFails "nrpn line too long" [nrpn line3 2 21 22 23 24 25]]

[mdt "NRPN...." [[control 10 99 127] [control 10 98 127]] [NRPN 10]]
[mdt "NRPN...." [[control 11 38 12] [control 11 6 0]] [NRPN 11 12]]
[mdt "NRPN...." [[control 11 38 116] [control 11 6 127]] [NRPN 11 -12]]
[mdt "NRPN...." [[control 13 99 14] [control 13 98 15]] [NRPN 13 14 15]]
[mdt "NRPN...." [[control 16 99 17] [control 16 98 18] [control 16 38 19] [control 16 6 0]] [NRPN 16 17 18 19]]
[mdt "NRPN...." [[control 20 99 21] [control 20 98 22] [control 20 38 122] [control 20 6 127]] [NRPN 20 21 22 -6]]
[mdt "NRPN...." [[control 0 99 31] [control 0 98 32] [control 0 38 34] [control 0 6 33]] [NRPN 0 31 32 33 34]]
[TestFails "NRPN too long" [NRPN 2 21 22 23 24 25]]
[mdt "NRPN line...." [[control 10 99 127] [control 10 98 127]] [NRPN line3 10]]
[mdt "NRPN line...." [[control 11 38 39] [control 11 6 5]] [NRPN line3 11 679]]
[mdt "NRPN line...." [[control 11 38 0x5a] [control 11 6 0x7a]] [NRPN line3 11 -678]]
[mdt "NRPN line...." [[control 13 99 14] [control 13 98 15]] [NRPN line3 13 14 15]]
[mdt "NRPN line...." [[control 16 99 17] [control 16 98 18] [control 16 38 2] [control 16 6 16]] [NRPN line3 16 17 18 2050]]
[mdt "NRPN line...." [[control 20 99 21] [control 20 98 22] [control 20 38 0x7e] [control 20 6 0x6f]] [NRPN line3 20 21 22 -2050]]
[mdt "NRPN line...." [[control 0 99 31] [control 0 98 32] [control 0 38 34] [control 0 6 33]] [NRPN line3 0 31 32 33 34]]
[TestFails "NRPN line too long" [NRPN line3 2 21 22 23 24 25]]

[line1 midi_manufacturers_id 125]

[mdt "egcopy...." [[SYSEX 125 72 82 67 115 68 72 37 38]] [egcopy 4 5 6]]
[mdt "egcopy_freq...." [[SYSEX 125 72 82 67 115 68 72 21 22]] [egcopy_freq 4 5 6]]
[mdt "egcopy_amp...." [[SYSEX 125 72 82 67 115 68 72 37 38]] [egcopy_amp 4 5 6]]
[mdt "egcopy_index...." [[SYSEX 125 72 82 67 115 68 72 5 6]] [egcopy_index 4 5 6]]
[mdt "egcopy_pan...." [[SYSEX 125 72 82 67 115 68 72 53 54]] [egcopy_pan 4 5 6]]

[TestWorks "delete mdt" [delallcl mdt]]

[exit]
